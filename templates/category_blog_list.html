{% extends "base.html" %}
{% load static %}

{% block title %}{{ category.name }} | Blog Post App{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/feed.css' %}">
{% endblock %}

{% block content %}
<div class="feed-container">
    <div class="mb-4">
        <a href="{% url 'category_list' %}" class="text-decoration-none text-muted mb-2 d-inline-block">
            <i class="bi bi-arrow-left"></i> All Categories
        </a>
        <h1 class="fw-bold">{{ category.name }}</h1>
        <p class="text-muted">Showing all posts in {{ category.name }}</p>
    </div>

    <div id="feed-container">
        <!-- Posts will be loaded here -->
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/auth.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadCategoryPosts();

        // Event delegation for interactions
        document.getElementById('feed-container').addEventListener('click', (e) => {
            const target = e.target.closest('.action-btn');
            if (!target) return;

            const postId = target.dataset.id;
            if (target.classList.contains('like-btn')) {
                handleLike(postId, target);
            } else if (target.classList.contains('comment-btn')) {
                toggleComments(postId);
            }
        });
    });

    // Load posts filtered by category
    async function loadCategoryPosts() {
        const container = document.getElementById('feed-container');
        container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        try {
            // Use the category name filter
            const categoryName = "{{ category.name }}";
            const url = `/api/blogs/?category__name=${encodeURIComponent(categoryName)}`;
            
            let response;
            if (TokenManager.isAuthenticated()) {
                response = await TokenManager.authenticatedFetch(url);
            } else {
                response = await fetch(url);
            }

            if (!response.ok) throw new Error('Failed to load posts');

            const posts = await response.json();
            container.innerHTML = '';

            if (posts.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted">No posts found in this category.</div>';
                return;
            }

            posts.forEach(post => {
                container.appendChild(createPostElement(post));
            });

        } catch (error) {
            console.error('Error loading category posts:', error);
            container.innerHTML = '<div class="alert alert-danger text-center">Failed to load posts. Please try again later.</div>';
        }
    }

    // Copied from feed.js to ensure consistent styling
    function createPostElement(post) {
        const div = document.createElement('div');
        div.className = 'post-card';

        // Format date
        const date = new Date(post.created_at).toLocaleDateString('en-US', {
            month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });

        // Author info
        const authorName = post.author.name || post.author.username;
        const authorAvatar = post.author.avatar || '/media/avatars/default/default.jpg';

        // Like button state
        const likeActive = post.is_liked ? 'liked' : '';
        const likeIcon = post.is_liked ? '‚ù§Ô∏è' : 'ü§ç';

        // Check if current user is the author (compare usernames)
        const currentUserId = TokenManager.getUserId();
        const isAuthor = currentUserId && post.author.username === TokenManager.getUsername();

        // Edit/Delete buttons for author (Using window functions from feed.js if available, or hide if not relevant for this page)
        // Note: Code for edit/delete is in feed.js which is not loaded here. 
        // We can either omit it or duplicate the modals logic. logic. 
        // For now, let's include it but simply not implement the handlers unless requested, to avoid errors.
        // Actually, let's omit the edit/delete buttons for the category view to keep it simple as "View Only" or we'd need to duplicate modal HTML too.
        // The requirement is "styling and functionality". The user wants like/comment. 
        // Let's stick to Like/Comment for now.
        
        div.innerHTML = `
            <div class="post-header">
                <a href="/accounts/profile/${post.author.username}/" style="text-decoration: none;">
                    <img src="${authorAvatar}" alt="${authorName}" class="post-avatar">
                </a>
                <div class="post-info">
                    <a href="/accounts/profile/${post.author.username}/" style="text-decoration: none; color: inherit;">
                        <h5>${authorName}</h5>
                    </a>
                    <p class="post-time">${date}</p>
                </div>
            </div>
            <div class="post-content">
                <a href="/baseapp/blog/${post.slug}/" style="text-decoration: none; color: inherit;">
                    <h3 class="post-title">${escapeHtml(post.title)}</h3>
                </a>
                <p class="post-text">
                    ${post.description.length > 200
                ? escapeHtml(post.description.substring(0, 200)) + '... <a href="/baseapp/blog/' + post.slug + '/" class="read-more-link" style="color:#007bff;text-decoration:underline;">Read more</a>'
                : escapeHtml(post.description)}
                </p>
                ${post.image ? `<a href="/baseapp/blog/${post.slug}/"><img src="${post.image}" alt="Post image" class="post-image rounded"></a>` : ''}
            </div>
            <div class="post-stats">
                <span class="likes-count">${post.likes_count} Likes</span>
                <span class="comments-count">${post.comments_count || 0} Comments</span> 
            </div>
            <div class="post-actions">
                <button class="action-btn like-btn ${likeActive}" data-id="${post.id}">
                    <span class="like-icon">${likeActive ? '‚ù§Ô∏è' : 'üëç'}</span> Like
                </button>
                <button class="action-btn comment-btn" data-id="${post.id}">
                    üí¨ Comment
                </button>
            </div>
            <div class="comments-section" id="comments-${post.id}" style="display: none; padding: 10px 16px; background: #f7f8fa;">
                <!-- Comments will be loaded here -->
                <div class="comments-list mb-3"></div>
                <div class="comment-input-wrapper d-flex">
                    <input type="text" class="form-control rounded-pill comment-input" placeholder="Write a comment..." data-id="${post.id}">
                    <button class="btn btn-primary btn-sm ms-2 rounded-pill send-comment-btn" data-id="${post.id}">Post</button>
                </div>
            </div>
        `;

        // Add event listener for comment input
        const sendBtn = div.querySelector('.send-comment-btn');
        const input = div.querySelector('.comment-input');

        sendBtn.addEventListener('click', () => submitComment(post.id, input));
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitComment(post.id, input);
        });

        return div;
    }

    async function handleLike(postId, btn) {
        if (!TokenManager.isAuthenticated()) {
            window.location.href = '/accounts/login/';
            return;
        }

        try {
            const response = await TokenManager.authenticatedFetch('/api/likes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ blog: postId })
            });

            if (response.ok) {
                const data = await response.json();
                const postCard = btn.closest('.post-card');
                const likesCountEl = postCard.querySelector('.likes-count');
                const likeIcon = btn.querySelector('.like-icon');

                // Toggle like state
                if (data.status === 'unliked') {
                    // User unliked the post
                    btn.classList.remove('liked');
                    likeIcon.textContent = 'üëç';
                    const currentCount = parseInt(likesCountEl.textContent);
                    likesCountEl.textContent = `${currentCount - 1} Likes`;
                } else {
                    // User liked the post
                    btn.classList.add('liked');
                    likeIcon.textContent = '‚ù§Ô∏è';
                    const currentCount = parseInt(likesCountEl.textContent);
                    likesCountEl.textContent = `${currentCount + 1} Likes`;
                }
            }
        } catch (error) {
            console.error('Error liking post:', error);
        }
    }

    function toggleComments(postId) {
        const section = document.getElementById(`comments-${postId}`);
        if (section.style.display === 'none') {
            section.style.display = 'block';
            loadComments(postId);
        } else {
            section.style.display = 'none';
        }
    }

    async function loadComments(postId) {
        const section = document.getElementById(`comments-${postId}`);
        const list = section.querySelector('.comments-list');
        list.innerHTML = '<small class="text-muted">Loading comments...</small>';

        try {
            const response = await fetch(`/api/comments/?blog=${postId}`); 

            if (response.ok) {
                const allComments = await response.json();
                const comments = allComments.filter(c => c.blog == postId);

                list.innerHTML = '';
                if (comments.length === 0) {
                    list.innerHTML = '<small class="text-muted">No comments yet.</small>';
                    return;
                }

                comments.forEach(comment => {
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'mb-2 p-2 bg-white rounded';
                    commentDiv.innerHTML = `
                        <strong>${escapeHtml(comment.user)}</strong> 
                        <span class="text-muted small ms-2">${new Date(comment.created_at).toLocaleDateString()}</span>
                        <p class="mb-0 small">${escapeHtml(comment.message)}</p>
                    `;
                    list.appendChild(commentDiv);
                });
            }
        } catch (error) {
            list.innerHTML = '<small class="text-danger">Error loading comments.</small>';
        }
    }

    async function submitComment(postId, input) {
        if (!TokenManager.isAuthenticated()) {
            window.location.href = '/accounts/login/';
            return;
        }

        const message = input.value.trim();
        if (!message) return;

        try {
            const response = await TokenManager.authenticatedFetch('/api/comments/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    blog: postId,
                    message: message
                })
            });

            if (response.ok) {
                input.value = '';
                loadComments(postId); // Reload comments
            }
        } catch (error) {
            console.error('Error posting comment:', error);
            alert('Failed to post comment');
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>
{% endblock %}
