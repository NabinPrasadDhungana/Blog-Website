{% extends "base.html" %}
{% load static %}

{% block title %}{{ category.name }} | Blog Post App{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/feed.css' %}">
{% endblock %}

{% block content %}
<div class="feed-container">
    <div class="mb-4">
        <a href="{% url 'category_list' %}" class="text-decoration-none text-muted mb-2 d-inline-block">
            <i class="bi bi-arrow-left"></i> All Categories
        </a>
        <h1 class="fw-bold">{{ category.name }}</h1>
        <p class="text-muted">Showing all posts in {{ category.name }}</p>
    </div>

    <div id="feed-container">
        <!-- Posts will be loaded here -->
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/auth.js' %}"></script>
<script>
    // Load posts filtered by category
    async function loadCategoryPosts() {
        const container = document.getElementById('feed-container');
        container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        try {
            // Use the category name filter
            const categoryName = "{{ category.name }}";
            const url = `/api/blogs/?category__name=${encodeURIComponent(categoryName)}`;
            
            let response;
            if (TokenManager.isAuthenticated()) {
                response = await TokenManager.authenticatedFetch(url);
            } else {
                response = await fetch(url);
            }

            if (!response.ok) throw new Error('Failed to load posts');

            const posts = await response.json();
            container.innerHTML = '';

            if (posts.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted">No posts found in this category.</div>';
                return;
            }

            posts.forEach(post => {
                container.appendChild(createPostElement(post));
            });

        } catch (error) {
            console.error('Error loading category posts:', error);
            container.innerHTML = '<div class="alert alert-danger text-center">Failed to load posts. Please try again later.</div>';
        }
    }

    // Create post element (copied from feed.js)
    function createPostElement(post) {
        const article = document.createElement('article');
        article.className = 'post-card';
        
        const postUrl = `/baseapp/${post.slug}/`;
        const authorUrl = `/accounts/profile/${post.author.username}/`;
        
        article.innerHTML = `
            <div class="post-header">
                <img src="${post.author.avatar || '/media/avatars/default/default.jpg'}" alt="${post.author.username}" class="author-avatar">
                <div class="author-info">
                    <a href="${authorUrl}" class="author-name">${post.author.username}</a>
                    <div class="post-meta">
                        <span class="post-date">${formatDate(post.created_at)}</span>
                        <span class="post-category">${post.category.name}</span>
                    </div>
                </div>
            </div>
            <div class="post-content">
                <h2 class="post-title"><a href="${postUrl}">${post.title}</a></h2>
                <p class="post-description">
                    ${post.description.length > 200
                        ? post.description.substring(0, 200) + '... <a href="' + postUrl + '" class="read-more-link">Read more</a>'
                        : post.description}
                </p>
                ${post.image ? `<img src="${post.image}" alt="${post.title}" class="post-image">` : ''}
            </div>
            <div class="post-footer">
                <button class="post-action like-btn" data-post-id="${post.id}">
                    <i class="bi bi-heart"></i>
                    <span class="like-count">${post.likes_count || 0}</span>
                </button>
                <a href="${postUrl}" class="post-action">
                    <i class="bi bi-chat"></i>
                    <span>${post.comments_count || 0}</span>
                </a>
            </div>
        `;
        
        return article;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) return 'Today';
        if (diffDays === 1) return 'Yesterday';
        if (diffDays < 7) return `${diffDays} days ago`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
        if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
        return `${Math.floor(diffDays / 365)} years ago`;
    }

    // Load posts when page loads
    document.addEventListener('DOMContentLoaded', () => {
        loadCategoryPosts();
    });
</script>
{% endblock %}
